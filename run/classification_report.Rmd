---
title: "Classification report"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r "loading data", echo=F}
library(ggplot2)
library(dplyr)
library(reshape2)
library(formattable)
library(webshot)

customGreen0 = "#DeF7E9"
customGreen = "#71CA97"

win_len <- 100000

data_path <- "../data/output/classifier_results/"

roc_auc_data <- read.csv(paste0(data_path, "all_result_roc_auc.csv"), row.names = 1, stringsAsFactors = F)
recall_data <- read.csv(paste0(data_path, "all_result_recall.csv"), row.names = 1, stringsAsFactors = F)
imp_data <- read.csv(paste0(data_path, "all_result_imp.csv"), row.names = 1, stringsAsFactors = F)

#' Export a Formattable as PNG, PDF, or JPEG
#'
#' @param f A formattable.
#' @param file Export path with extension .png, .pdf, or .jpeg.
#' @param width Width specification of the html widget being exported.
#' @param height Height specification of the html widget being exported.
#' @param background Background color specification.
#' @param delay Time to wait before taking webshot, in seconds.
#'
#' @importFrom formattable as.htmlwidget
#' @importFrom htmltools html_print
#' @importFrom webshot webshot
#'
#' @export
export_formattable <- function(f, file, width = "100%", height = NULL, 
                               background = "white", delay = 0.2)
{
  w <- as.htmlwidget(f, width = width, height = height)
  path <- html_print(w, background = background, viewer = NULL)
  url <- paste0("file:///", gsub("\\\\", "/", normalizePath(path)))
  webshot(url,
          file = file,
          selector = ".formattable_widget",
          delay = delay)
}

```

### ROC AUC analysis

```{r}
all_features_data <- roc_auc_data %>%
  filter(feat_group == "all") %>%
  filter(agg_level != "all")

roc_auc_cancer_stats <- all_features_data %>%
  group_by(cancer_type) %>%
  summarize(
    min_test_auc = min(te_auc),
    sd_test_auc = sd(te_auc),
    test_auc = median(te_auc),
    test_auc_mean = mean(te_auc),
    n_auc = n(),
    train_auc = median(tr_auc)
  )

roc_auc_cancer_stats %>% 
  arrange(min_test_auc)
```


```{r fig.width=10}
ggplot(all_features_data, aes(te_auc, fill=agg_level)) +
  geom_density(alpha=0.5)+
  facet_wrap(~ cancer_type, nrow = 2) +
  ggtitle("Distribution of test ROC AUC for all cancer types by hotspots labeling")
  
```

```{r echo=F}
by_hspt <- all_features_data %>%
  mutate(
    train_test_diff = tr_auc - te_auc
  ) %>%
  group_by(cancer_type, agg_level) %>%
  summarize(
    min_test_auc = min(te_auc),
    sd_test_auc = sd(te_auc),
    test_auc = median(te_auc),
    test_auc_mean = mean(te_auc),
    train_test_diff = mean(train_test_diff)
  ) 
```

Minimal test ROC AUC for each cancer type and labeling.

```{r}

by_hspt_min <- by_hspt %>%
  select(cancer_type, agg_level, min_test_auc, test_auc, train_test_diff) %>%
  dcast(formula = cancer_type ~ agg_level, value.var = "min_test_auc")
names(by_hspt_min)[2:ncol(by_hspt_min)] <- paste0("min_test_", names(by_hspt_min)[2:ncol(by_hspt_min)])

# export_formattable()

formattable(by_hspt_min, align =c("l","c","c","c"), list(
  `cancer_type` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `min_test_99.`= color_tile(customGreen0, customGreen),
  `min_test_99.5.`= color_tile(customGreen0, customGreen),
  `min_test_99.9.`= color_tile(customGreen0, customGreen)
))

```


Median test ROC AUC for each cancer type and labeling.

```{r}

by_hspt_med <- by_hspt %>%
  select(cancer_type, agg_level, min_test_auc, test_auc, train_test_diff) %>%
  dcast(formula = cancer_type ~ agg_level, value.var = "test_auc")
names(by_hspt_med)[2:ncol(by_hspt_med)] <- paste0("median_test_", names(by_hspt_med)[2:ncol(by_hspt_med)])

formattable(by_hspt_med, align =c("l","c","c","c"), list(
  `cancer_type` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `median_test_99.`= color_tile(customGreen0, customGreen),
  `median_test_99.5.`= color_tile(customGreen0, customGreen),
  `median_test_99.9.`= color_tile(customGreen0, customGreen)
))

```


Difference between train and test ROC AUC for each cancer type and labeling.

```{r}

by_hspt_diff <- by_hspt %>%
  select(cancer_type, agg_level, min_test_auc, test_auc, train_test_diff) %>%
  dcast(formula = cancer_type ~ agg_level, value.var = "train_test_diff")
names(by_hspt_diff)[2:ncol(by_hspt_diff)] <- paste0("diff_", names(by_hspt_diff)[2:ncol(by_hspt_diff)])

formattable(by_hspt_diff, align =c("l","c","c","c"), list(
  `cancer_type` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `diff_99.`= color_tile(customGreen0, customGreen),
  `diff_99.5.`= color_tile(customGreen0, customGreen),
  `diff_99.9.`= color_tile(customGreen0, customGreen)
))

```

```{r fig.width=10}
ggplot(by_hspt, aes(x=test_auc, y=train_test_diff, color=agg_level, size=sd_test_auc)) + 
  geom_point() + 
  geom_text(aes(label=cancer_type), size=3, vjust=0, hjust=1.5)

```

<!-- Чем более редкие хотспоты хотим обнаружить, тем больше разброс метрики на тесте (мало позитивных примеров и в зависимости от выборки получаем разные результаты), так же, как и разница между обучением и тестом. -->
<!-- Хотя для двух типов рака (breast, ovary) разница между обучением и тестом на самом высоком уровне такая же, как и при других уровнях маркировки (при этом еще и минимальных среди всех типов рака), а медианное качество выше. -->

```{r}

by_hspt_99 <- by_hspt %>%
  filter(agg_level == "99.") %>%
  select(cancer_type, min_test_auc, sd_test_auc, test_auc, train_test_diff) %>%
  setNames(c("cancer_type", "99._min_test_auc", "99._sd_test_auc", "99._test_auc", "99._train_test_diff"))

by_hspt_99.9 <- by_hspt %>%
  filter(agg_level == "99.9.") %>%
  select(cancer_type, min_test_auc, sd_test_auc, test_auc, train_test_diff) %>%
  setNames(c("cancer_type", "99.9_min_test_auc", "99.9_sd_test_auc", "99.9_test_auc", "99.9_train_test_diff"))

data_for_clustering <- by_hspt_99.9 %>%
  inner_join(by_hspt_99, by = "cancer_type") %>%
  mutate(
    min_diff = `99._min_test_auc` - `99.9_min_test_auc`,
    median_diff = `99._test_auc` - `99.9_test_auc`,
    train_test_diff = `99._train_test_diff` - `99.9_train_test_diff`
  ) %>%
  select(cancer_type, min_diff, median_diff, train_test_diff)
data_for_clustering <- data.frame(data_for_clustering)
rownames(data_for_clustering) <- data_for_clustering$cancer_type
data_for_clustering$cancer_type <- NULL

library("ggdendro")
dd <- dist(scale(data_for_clustering), method = "euclidean")
hc <- hclust(dd, method = "ward.D2")
clusMember <- cutree(hc, 3)
data_for_clustering$cluster <- clusMember
ggdendrogram(hc, segments = T, theme_dendro = F)
```


```{r}

data_for_clustering %>%
  group_by(cluster) %>%
  summarize_all(mean)

```

<!-- Кластеры можно описать так: -->
<!-- 1. при выделении меньшего количества хотспотов разница между обучением и тестом становится больше (переобучение выражается сильнее), но медианный тестовый ROC AUC становится выше (blood, bone, brain, pancreatic, protate, skin) -->
<!-- 2. при выделении меньшего количества хотспотов разница между обучением и тестом не увеличивается (переобучение не становится больше), а медианный тестовый ROC AUC становится выше (breast, ovary, uterus) - можно предположить, что для данных типов рака лучше всего определяются скопления разрывов с порогом 99,9% -->
<!-- 3. при выделении меньшего количества хотспотов разница между обучением и тестом становтся очень большой, а медианный тестовый ROC AUC становится ниже (liver) - можно предположить, что для данного типа рака лучше всего определяются скопления разрывов с порогом 99% -->

```{r}

# by_hspt %>%
#   filter(agg_level %in% c ("99.","99.5.")) %>%
#   group_by(cancer_type) %>%
#   filter(test_auc == max(test_auc))

best_labeling <- data.frame(
  cancer_type = c("liver", "breast", "ovary", "uterus", "blood", "bone", "brain", "pancreatic", "prostate","skin"),
  agg_level = c("99.", "99.9.", "99.9.", "99.9.", "99.", "99.5.", "99.5.", "99.", "99.5.","99."),
  stringsAsFactors = F)

best_labeling <- all_features_data %>%
  inner_join(best_labeling, by=c("cancer_type","agg_level")) %>%
  mutate(
    train_test_diff = tr_auc - te_auc
  ) %>%
  group_by(cancer_type, agg_level) %>%
  summarize(
    min_test_auc = min(te_auc),
    sd_test_auc = sd(te_auc),
    test_auc = median(te_auc),
    test_auc_mean = mean(te_auc),
    train_test_diff = mean(train_test_diff)
  ) 
best_labeling
```
Итого:
для нескольких типов рака (breast, ovary, uterus) меньшее количество хотспотов (более ярко выраженные) лучше определяются, чем большее количество хотспотов (ярко выраженные + менее ярко выраженные), при этом качество отлично от случайного (минимальный ROC AUC 0.69/0.59/0.57, медианный - 0,83/0,76/0,66) и даже более того - лучшее при сравнении с остальными типами рака по медиане (исключая prostate)
Отсюда гипотеза:
Разрывы могут появляться в случайных местах, но есть участки генома, более подверженные (неустойчивые) этому, и их немного.

Интересно:
Может и другие разрывы в этих участках? Может это какая-то глобальная неустойчивость (может проверить по другим заболеваниям?)
breast, ovary, uterus, prostate - лучшие по медиане ROC AUC - интересно, что именно "половые" типы рака (Y хромосому не рассматриваем)



#### How different feature groups removal effect overall performance

Обратить внимание на разницу в важности фичей между разными типами рака
и в одном типе рака для разных agg_level

Preprocess data:

```{r, echo=F}
all_features_data_full <- roc_auc_data %>%
  filter(agg_level != "all")

# train auc
all_features_data_full_tr <- dcast(data = all_features_data_full, formula = cancer_type + agg_level + iter ~ feat_group, value.var = "tr_auc")
all_features_data_full_tr <- all_features_data_full_tr %>%
  select(
    cancer_type, agg_level, iter, all, wo_chromatin, wo_histones, wo_methyl, wo_reg, wo_sec_str, wo_tad, wo_tf) %>%
  setNames(
    c('cancer_type', 'agg_level', 'iter', 'tr_auc_all', 'tr_auc_wo_chromatin', 'tr_auc_wo_histones', 
      'tr_auc_wo_methyl', 'tr_auc_wo_reg', 'tr_auc_wo_sec_str', 'tr_auc_wo_tad', 'tr_auc_wo_tf'))
# test auc
all_features_data_full_te <- dcast(data = all_features_data_full, formula = cancer_type + agg_level + iter ~ feat_group, value.var = "te_auc")
all_features_data_full_te <- all_features_data_full_te %>%
  select(
    cancer_type, agg_level, iter, all, wo_chromatin, wo_histones, wo_methyl, wo_reg, wo_sec_str, wo_tad, wo_tf) %>%
  setNames(
    c('cancer_type', 'agg_level', 'iter', 'te_auc_all', 'te_auc_wo_chromatin', 'te_auc_wo_histones', 
      'te_auc_wo_methyl', 'te_auc_wo_reg', 'te_auc_wo_sec_str', 'te_auc_wo_tad', 'te_auc_wo_tf'))

# all
all_features_data_full_df <- all_features_data_full_te %>%
  inner_join(all_features_data_full_tr, by=c("cancer_type", "agg_level", "iter"))

# difference between train and test
cols <- c('all', 'wo_chromatin', 'wo_histones', 'wo_methyl', 'wo_reg', 'wo_sec_str', 'wo_tad', 'wo_tf')
for (col in cols){
  all_features_data_full_df <- all_features_data_full_df %>%
    mutate(
      !!as.name(paste0("diff_", col)) := !!as.name(paste0("tr_auc_", col)) - !!as.name(paste0("te_auc_", col))
      )
}

# difference in test ROC AUC between all features set and reduced set
cols <- c('wo_chromatin', 'wo_histones', 'wo_methyl', 'wo_reg', 'wo_sec_str', 'wo_tad', 'wo_tf')
for (col in cols){
  all_features_data_full_df <- all_features_data_full_df %>%
    mutate(
      !!as.name(paste0("reduced_test_loss_", col)) := te_auc_all - !!as.name(paste0("te_auc_", col))
      )
}


# difference in "difference between train and test ROC AUC" between all features set and reduced set
cols <- c('wo_chromatin', 'wo_histones', 'wo_methyl', 'wo_reg', 'wo_sec_str', 'wo_tad', 'wo_tf')
for (col in cols){
  all_features_data_full_df <- all_features_data_full_df %>%
    mutate(
      !!as.name(paste0("reduced_diff_loss_", col)) := diff_all - !!as.name(paste0("diff_", col))
      )
}
```

Distribution of test ROC AUC loss 

```{r fig.width=10, fig.height=7}

reduced_test_loss_cols <- grep(x = names(all_features_data_full_df), pattern = "reduced_test_loss_", value = T)

reduced_test_df <- all_features_data_full_df %>%
  select(c("cancer_type", "agg_level", reduced_test_loss_cols))
reduced_test_df <- melt(data = reduced_test_df, id.vars = c("cancer_type","agg_level"))
reduced_test_df$feature_group <- as.character(reduced_test_df$variable) 
reduced_test_df$feature_group <- gsub(x = reduced_test_df$feature_group, 
                                      pattern = "reduced_test_loss_wo_", replacement = "")

ggplot(reduced_test_df, aes(x=feature_group, y=value, fill=agg_level))+
  geom_boxplot() + 
  facet_wrap(~ cancer_type, nrow = 4)
```

```{r}
agg_cancer <- reduced_test_df %>%
  group_by(cancer_type, feature_group) %>%
  summarize(mean_decrease = mean(value)) 
agg_cancer[agg_cancer$mean_decrease == 0, "mean_decrease"] <- NA
agg_cancer <- agg_cancer %>%
    mutate(mean_decrease = round(mean_decrease, 4))

agg_cancer_dcast <- dcast(agg_cancer, formula = cancer_type ~ feature_group, value.var = "mean_decrease")

formattable(agg_cancer_dcast, align =c("l", "c", "c","c","c", "c","c","c"), list(
  `cancer_type` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `chromatin`= color_tile("#3ea9cc", customGreen),
  `histones`= color_tile("#3ea9cc", customGreen),
  `methyl`= color_tile("#3ea9cc", customGreen),
  `reg`= color_tile("#3ea9cc", customGreen),
  `sec_str`= color_tile("#3ea9cc", customGreen),
  `tad`= color_tile("#3ea9cc", customGreen),
  `tf`= color_tile("#3ea9cc", customGreen)
))

```

```{r}
agg_cancer %>%
  group_by(cancer_type) %>%
  filter(mean_decrease == max(mean_decrease, na.rm = T)) %>%
  arrange(desc(mean_decrease))
  
```
Итого:
Хотелось бы сделать вывод, что вторичные структуры самые важные для предсказания разрывов, но нельзя :) 
С одной стороны, видим, что удаление данных о вторичных структурах больше всего вредит качеству модели.
С другой стороны, если вернуться к оценке корреляций между группами фичей, можно увидеть, что вторичные структуры меньше остальных фичей скоррелрованы с остальными. Поэтому при поэтапном удалении из рассмотрения вторичных структур получается большой провал качества, а при удалении остальных - маленький, так как ввиду скоррелированности их можно чем-то другим компенсировать. 


#### Выделение всех разрывов


```{r}
all_bkpt_data <- roc_auc_data %>%
  filter(agg_level == "all")

all_bkpt_data_all <- all_bkpt_data %>%
  filter(feat_group == "all") 

roc_auc_cancer_stats_all <- all_bkpt_data_all %>%
  group_by(cancer_type) %>%
  summarize(
    min_test_auc = min(te_auc),
    sd_test_auc = sd(te_auc),
    test_auc = median(te_auc),
    test_auc_mean = mean(te_auc),
    n_auc = n(),
    train_auc = median(tr_auc)
  )

roc_auc_cancer_stats_all %>% 
  arrange(min_test_auc)
```

Compare with results for hotspots

```{r}
comp_df <- best_labeling %>%
  select(cancer_type, min_test_auc, test_auc) %>%
  setNames(c("cancer_type", "hotspot_min_test_auc", "hotspot_test_auc")) %>%
  inner_join(
    roc_auc_cancer_stats_all %>% 
      select(cancer_type, min_test_auc, test_auc) %>%
      setNames(c('cancer_type', 'breakpoints_min_test_auc', 'breakpoints_test_auc')),
    by=c("cancer_type")
  )

comp_df %>%
  select(cancer_type, breakpoints_min_test_auc, hotspot_min_test_auc, breakpoints_test_auc, hotspot_test_auc) 
```

```{r fig.width=10, fig.asp=0.5}

best_hsp_bkpt <- all_features_data %>%
  filter(feat_group == "all") %>%
  inner_join(best_labeling, by = c("cancer_type", "agg_level")) %>%
  select(cancer_type, te_auc) %>%
  mutate(type="hotspot") %>%
  union(
    all_bkpt_data_all %>%
      select(cancer_type, te_auc) %>%
      mutate(type="breakpoints") 
  )

ggplot(best_hsp_bkpt, aes(x=cancer_type, y=te_auc, fill=type)) + 
  geom_boxplot() + 
  ggtitle('Distribution of test ROC AUC for best labeling hotspot profile
          and all breakpoints prediction')
```

Итого:
При выделении всех разрывов по сравнению с выделением хотспотов удается достичь меньшего разброса по качеству моделей при разбивке на обучение и тест (возможно, по причине большего количества примеров положительного класса и соответственно большего колчества примеров для обучения при построении каждого дерева). 
 
Можно выделить три группы типов рака по соотношению качества:
 - blood, brain - для этих типов рака медиана тестового ROC AUC выше для модели предсказания разрывов
 - bone, prostate, skin, liver, pancreatic - для этих типов рака медиана тестового ROC AUC для модели предсказания разрывов на том же уровне, что для модели предсказания хотспотов
 - breast, ovary, uterus - для этих типов рака медиана тестового ROC AUC выше для модели предсказания хотспотов
Разрыв в качестве проявляется тем больше,чем выше качество моделей предсказания хотспотов.

### Recall analysis

Aggregated statistics for hotspots prediction by cancer type

```{r fig.width=10}
all_features_data <- recall_data %>%
  filter(feat_group == "all") %>%
  filter(agg_level != "all")

all_features_data$agg_level <- as.character(all_features_data$agg_level)
all_features_data$quantile_chr <- as.character(all_features_data$quantile)

ggplot(all_features_data[all_features_data$quantile_chr %in% 
                           c("0.1", "0.2", "0.3", "0.4", "0.5"), ], 
       aes(x=quantile_chr, y=recall, fill=agg_level)) +
  geom_boxplot() +
  facet_wrap(~cancer_type)
```

Видно, что самый высокий уровень выделения хотспотов (99,9) показывает наибольшую полноту по сравнению с другими типами маркировки для всех типов рака.


Lift of recall for all cancer types by labeling type

```{r fig.width=10}
raw_dat <- read.csv("../data/datasets/dataset_100000.csv")
hsp_cols <- grep(x = names(raw_dat), pattern = "hsp", value = TRUE)
df_pos <- data.frame()
for (col in hsp_cols){
  df_pos <- rbind(df_pos, 
                  data.frame(
                    agg_level = strsplit(col, split = "_")[[1]][[2]],
                    cancer_type = strsplit(col, split = "_")[[1]][[3]],
                    n_true = sum(raw_dat[col]),
                    n_total = nrow(raw_dat)
                  )
  )
}

all_features_data <- all_features_data %>%
  inner_join(df_pos, by=c("cancer_type", "agg_level"))

all_features_data$lift_recall <- all_features_data$recall / all_features_data$quantile
ggplot(all_features_data[all_features_data$quantile_chr %in% 
                           c("0.05", "0.1", "0.2", "0.3", "0.4", "0.5"), ], 
       aes(x=quantile_chr, y=lift_recall, fill=agg_level)) +
  geom_boxplot() +
  facet_wrap(~cancer_type)
```

Для всех типов рака медиана lift of recall (так же, как и разброс этой метрики) монотонно убывает в зависимости от probability quantile, достигая максимума при выделении 5% окон в качестве хотспотов. На этом графике видно, что выделение меньшего количества более ярко выраженных хотспотов позволяет добиться более высокого качества предсказаний.

Recall for 99.9 aggregation level

```{r fig.width=10}
recall_best_agg <- all_features_data[(all_features_data$quantile_chr %in% 
                           c("0.05", "0.1", "0.15","0.2", "0.3", "0.4", "0.5")) & (all_features_data$agg_level == "99.9."), ]
rec_med <- recall_best_agg %>%
  group_by(cancer_type, quantile) %>%
  summarize(
    med_recall = median(recall),
    med_lift = median(lift_recall),
    sd_recall = sd(recall),
    sd_lift = sd(lift_recall)
    )

recall_best_agg <- recall_best_agg %>% 
         inner_join(rec_med, by = c("quantile", "cancer_type")) %>% 
         arrange(quantile, med_recall)

ggplot(recall_best_agg, 
       aes(x=quantile_chr, y=recall, fill=reorder(cancer_type, recall, FUN=median))) +
  geom_boxplot()

```

Median lift of recall

```{r fig.width=10}

ggplot(rec_med, aes(x=as.character(quantile), y=med_lift, col=cancer_type, group=cancer_type)) +
  geom_line(position=position_dodge(width=0.3)) + 
  geom_point(position=position_dodge(width=0.3))

```

Select best cutoff (where median lift of recall is maximal) from 5% and 10% quantile and show statistics for them

```{r}
best_thr <- rec_med %>%
  filter(quantile <= 0.1) %>%
  filter(med_lift == max(med_lift)) %>%
  filter(med_recall == max(med_recall)) %>%
  arrange(med_lift, med_recall)


formattable(best_thr, align = c("l","c","c","c","c","c"), list(
  `cancer_type` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `quantile` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
  `med_recall`= color_tile(customGreen0, customGreen),
  `med_lift`= color_tile(customGreen0, customGreen),
  `sd_recall`= color_tile(customGreen0, customGreen),
  `sd_lift`= color_tile(customGreen0, customGreen)
))

```

Итого:
При выборе оптимального уровня маркировки хостпотов с точки зрения максимальной полноты можно сделать вывод о том, что выделение 99,9%-хотспотов является наиболеее качественным для всех типов рака. При этом, если при формировании предсказаний выбрать такой порог, что метка "хотспот" будет проставлена для 5-10% окон, то breast/pancreatic будут иметь полноту более 0,33 и прирост полноты более 6,66, liver - полноту 0,125 и прирост полноты 1,25, остальные типы рака - полноту от 0,22 до 0,25 и пирост полноты от 2,22 до 5.


Median lift of recall among all probability quantiles

```{r}
recall_best_agg %>%
  group_by(cancer_type) %>%
  summarize(
    med_lift = median(lift_recall)
    )
```



#### Выделение всех разрывов

Distribution of recall by probability quantile, cancer type and task (prediction of hotspots or breakpoints) 

```{r fig.width=10}
recall_best_agg <- recall_data[(recall_data$feat_group == "all") & (recall_data$agg_level == "99.9."), ]
recall_all_agg <- recall_data[(recall_data$feat_group == "all") & (recall_data$agg_level == "all"), ]
recall_comp <- rbind(
  recall_best_agg %>%
    mutate(type="hotspots"),
  recall_all_agg %>%
    mutate(type="breakpoints")
)
recall_comp$quantile_chr <- as.character(recall_comp$quantile)

ggplot(recall_comp[recall_comp$quantile_chr %in% c("0.5", "0.4", "0.3", "0.2",  "0.15", "0.1", "0.05"), ], 
       aes(x=quantile_chr, y=recall, fill=type)) +
  geom_boxplot() +
  facet_wrap(~cancer_type)

```

Distribution of lift of recall for all probability quantiles by task

```{r fig.width=10}
recall_comp$lift_recall <- recall_comp$recall / recall_comp$quantile
ggplot(recall_comp, aes(lift_recall, fill=type)) +
  geom_density(alpha=0.7) + 
  facet_wrap(~cancer_type, scales = "free")
```

Median lift of recall for all probability quantiles

```{r}
recall_all_agg$lift_recall <- recall_all_agg$recall / recall_all_agg$quantile
recall_all_agg %>%
  group_by(cancer_type) %>%
  summarize(
    med_lift_bkpt = median(lift_recall)
    )
```

Comparison of median lift of recall and median recall for 0.5-0.1 probability quantiles for task of hotspots prediction and breakpoints prediction

```{r}

agg_recall_all_agg <- recall_all_agg %>%
  group_by(cancer_type, quantile) %>%
  summarize(
    med_recall_bkpt = median(recall),
    med_lift_bkpt = median(lift_recall),
    sd_recall_bkpt = sd(recall),
    sd_lift_bkpt = sd(lift_recall)
    )

comp_best_all <- best_thr %>%
  left_join(agg_recall_all_agg, by=c("cancer_type", "quantile"))

comp_best_all %>%
  select("cancer_type", "quantile", "med_recall","med_recall_bkpt","med_lift", "med_lift_bkpt",
         "sd_recall","sd_recall_bkpt", "sd_lift","sd_lift_bkpt")

```

Итого:
При сравнении полноты в задачах предсказания 99,9%-хотспотов и разрывов было выявлено,что хотспоты выделяются намного легче. Конкретно, медиана прироста полноты в задаче предсказания разрывов по всем probability quantile равна 0 для всех типов рака за исключением breast, ovary, pancreatic, prostate, где она колеблется от 0,08 до 0,87, в то время как в задаче предсказания хотспотов этот показатель варьируется в диапазоне от 1 до 3,12.

